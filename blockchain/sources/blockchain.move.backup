module blockchain::optic_gov {
    use sui::transfer;
    use sui::object::{Self, UID};
    use sui::coin::{Self, Coin};
    use sui::balance::{Self, Balance};
    use sui::sui::SUI;
    use sui::tx_context::{Self, TxContext};

    // --- Errors ---
    const EInvalidAmount: u64 = 1;

    // ====================================================================
    // 1. OBJECTS
    // ====================================================================

    /// The Access Key for the AI Oracle
    struct OracleCap has key, store {
        id: UID,
    }

    /// The Project Escrow Object
    struct Project has key, store {
        id: UID,
        funder: address,
        contractor: address,
        // Using Balance instead of Coin for internal storage is best practice
        escrow_balance: Balance<SUI>, 
        total_budget: u64,
        funds_released: u64,
        milestone_count: u64,
        // We will add milestones/IPFS logic in Phase 3
    }

    // ====================================================================
    // 2. INITIALIZATION
    // ====================================================================

    fun init(ctx: &mut TxContext) {
        // AI Oracle address from your .env
        let oracle_address = @0x148ba9e6f4600094f3a680b935116dff42901212; 
        
        transfer::transfer(
            OracleCap { id: object::new(ctx) }, 
            oracle_address
        );
    }

    // ====================================================================
    // 3. PHASE 2: CREATION & FUNDING
    // ====================================================================

    /// The Funder calls this, passing a SUI Coin and the Contractor's address.
    public entry fun create_project(
        payment: Coin<SUI>,
        contractor: address,
        milestone_count: u64,
        ctx: &mut TxContext
    ) {
        let total_budget = coin::value(&payment);
        assert!(total_budget > 0, EInvalidAmount);

        let funder_address = tx_context::sender(ctx);

        // Convert the Coin into a Balance to store it inside the Project
        let project_balance = coin::into_balance(payment);

        let project = Project {
            id: object::new(ctx),
            funder: funder_address,
            contractor,
            escrow_balance: project_balance,
            total_budget,
            funds_released: 0,
            milestone_count,
        };

        // Crucial: Transfer the Project object to the Funder.
        // The Funder now "owns" this escrow container on-chain.
        transfer::transfer(project, funder_address);
    }
}